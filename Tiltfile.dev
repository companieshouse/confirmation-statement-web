local_resource(
  name = 'dev:confirmation-statement-web',
  cmd = 'npm --silent install && npm --silent run build',
  deps = ['src', 'views']
)

ssh_key_path = ''
if config.tilt_subcommand == 'up':
    ssh_key_path = str(local("ssh -G github.com 2>/dev/null |sed -n '/identityfile/{s/.* \\(.*\\)/\\1/p;q;}'")).rstrip('\n')

    if not ssh_key_path:
        fail ("Could not find ssh key path for github.com")

    home = os.getenv("HOME")
    ssh_key_path = ssh_key_path.replace('~', home)
    if not os.path.exists ( ssh_key_path ):
        fail ("Could not find ssh key for github at " + ssh_key_path)


custom_build(
  ref = '169942020521.dkr.ecr.eu-west-1.amazonaws.com/local/confirmation-statement-web',
  command = 'DOCKER_BUILDKIT=0 docker build --build-arg SSH_PRIVATE_KEY="$(cat ~/.ssh/id_rsa)" --build-arg SSH_PRIVATE_KEY_PASSPHRASE --tag $EXPECTED_REF .',
  live_update = [
    sync(local_path = './src', remote_path = '/app/src'),
    sync(local_path = './views', remote_path = '/app/views'),
    restart_container()
  ],
  deps = [
    './dist',
    './src',
    './views'
  ]
)
